name: Sync APISIX Config

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  apisix-sync:
    runs-on: self-hosted
    env:
      ADC_SERVER: http://localhost:9180 # e.g., http://your-apisix:9180
      ADC_TOKEN: edd1c9f034335f136f87ad84b625c8f1  # APISIX Admin API Key
      ADC_BACKEND: apisix

    steps:
      - uses: actions/checkout@v4

      # 1. Install ADC
      - name: Install ADC
        run: curl -sL "https://run.api7.ai/adc/install" | sh

      # 2. Lint and Validate (Prevents applying broken configs)
      - name: Validate Config
        run: adc validate -f apisix.yaml

      # 3. Preview Changes (Diff)
      - name: Diff Config
        run: adc diff -f apisix.yaml

      # 4. Apply Changes (Only on Push to Main)
      - name: Sync to APISIX
        if: github.event_name == 'push'
